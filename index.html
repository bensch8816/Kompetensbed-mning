<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Självskattning - Kompetensbedömning IT-service</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #2d3561;
            --primary-light: #4a5a8f;
            --accent: #ff6b35;
            --bg: #f8f9fc;
            --surface: #ffffff;
            --text: #1a1d2e;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --warning: #ffd700;
            --success: #4caf50;
        }

        body {
            font-family: 'Instrument Sans', sans-serif;
            background-image: url('image.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 60px 40px;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 20px 60px rgba(45, 53, 97, 0.2);
        }

        .header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 15px; }
        .header p { font-size: 1.1em; opacity: 0.95; max-width: 700px; margin-bottom: 20px; }

        .header-note {
            background: rgba(255, 215, 0, 0.2);
            border-left: 4px solid var(--warning);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.95em;
        }

        .header-note strong { display: block; font-size: 1.1em; margin-bottom: 8px; }

        #userInfo {
            margin-top: 15px;
            opacity: 0.9;
            font-size: 0.95em;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 10px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, #ff8555 100%);
            transition: width 0.3s;
            width: 0%;
        }

        .section {
            background: var(--surface);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }

        .section-title {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .section-subtitle {
            font-size: 0.95em;
            color: var(--text-light);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .question { margin-bottom: 32px; }
        .question-text { font-weight: 600; color: var(--text); margin-bottom: 16px; font-size: 1.05em; }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            background: var(--surface);
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%232d3561' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        .option {
            display: block;
            padding: 16px 18px;
            margin-bottom: 10px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option:hover { border-color: var(--accent); background: #fff5f2; }

        .option input[type="checkbox"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .frequency-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
        }

        .freq-header {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .freq-header:first-child { text-align: left; border-radius: 10px 0 0 0; }
        .freq-header:last-child { border-radius: 0 10px 0 0; }

        .freq-row { background: var(--surface); }
        .freq-row:hover { background: var(--bg); }

        .freq-label {
            padding: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-right: none;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .freq-row:first-child .freq-label { border-top: 2px solid var(--primary); }

        .freq-cell {
            padding: 16px;
            text-align: center;
            background: var(--surface);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .freq-row:first-child .freq-cell { border-top: 2px solid var(--primary); }
        .freq-cell:last-child { border-right: 1px solid var(--border); }

        .freq-cell input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .submit-btn {
            display: block;
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--accent) 0%, #ff8555 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 40px;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .result-container {
            display: none;
            margin-top: 50px;
            padding: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 20px 60px rgba(45, 53, 97, 0.3);
        }

        .result-container.show { display: block; animation: slideUp 0.6s; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-warning {
            background: rgba(255, 215, 0, 0.2);
            border-left: 4px solid var(--warning);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .result-warning strong { display: block; font-size: 1.2em; margin-bottom: 10px; }

        .score-circle {
            width: 180px;
            height: 180px;
            margin: 0 auto 30px;
            border-radius: 50%;
            border: 8px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: rgba(255,255,255,0.1);
        }

        .score-number { font-size: 3em; font-weight: 700; line-height: 1; }
        .score-total { font-size: 1.2em; opacity: 0.9; }

        .result-level { font-size: 2.5em; font-weight: 700; text-align: center; margin: 30px 0 20px; }
        .result-desc { text-align: center; font-size: 1.2em; opacity: 0.95; margin-bottom: 40px; }

        .result-breakdown {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 16px;
            margin: 30px 0;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .breakdown-item:last-child { border-bottom: none; }

        .breakdown-label { flex: 1; }
        .breakdown-label strong { display: block; font-size: 1.1em; margin-bottom: 5px; }
        .breakdown-label span { opacity: 0.85; font-size: 0.95em; }

        .breakdown-value { font-size: 2em; font-weight: 700; margin-left: 30px; }

        .breakdown-bottleneck {
            color: var(--warning);
            font-size: 0.5em;
            margin-left: 10px;
            font-weight: 600;
        }

        .email-btn {
            display: inline-block;
            padding: 16px 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            margin-right: 10px;
        }

        .email-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
            transform: translateY(-2px);
        }

        .email-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .hidden { display: none !important; }

        /* Email status modal */
        .email-status-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .email-status-modal.show {
            display: flex;
        }

        .email-status-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 500px;
            text-align: center;
            color: var(--text);
        }

        .email-status-content h2 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        .email-status-content .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .email-status-content .success-icon {
            font-size: 50px;
            margin: 20px 0;
        }

        .email-status-content button {
            margin-top: 20px;
            padding: 12px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .header { padding: 40px 30px; }
            .header h1 { font-size: 2em; }
            .section { padding: 30px 20px; }
            .frequency-table { font-size: 0.85em; }
            .freq-label, .freq-cell { padding: 12px 8px; }
            .email-btn { display: block; margin: 10px 0; width: 100%; }
        }
    </style>
    <!-- MSAL.js för Graph API autentisering -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    <!-- jsPDF + html2canvas för PDF-generering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Självskattning - Kompetensbedömning IT-service</h1>
            <p>Underlag för dialog med din chef</p>
            
            <div class="header-note">
                <strong>⚠️ Viktigt att veta:</strong>
                Detta är en <strong>självskattning</strong> som används som underlag för dialog med din chef. 
                Din chef gör den officiella bedömningen enligt organisationens nivåkriterier.
            </div>
            
            <div id="userInfo"></div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <form id="assessmentForm">
            
            <!-- SEKTION 1: BEFATTNINGSVAL -->
            <div class="section">
                <div class="section-title">Välj din befattning</div>
                <div class="question">
                    <select name="befattning" id="befattningSelect" required>
                        <option value="">-- Välj befattning --</option>
                        <option value="it_produktforsorjning">IT-produktförsörjning</option>
                        <option value="kundansvarig">Kundansvarig</option>
                        <option value="systemutvecklare">Systemutvecklare</option>
                        <option value="natverkstekniker">Nätverkstekniker</option>
                        <option value="it_projektledare">IT Projektledare</option>
                        <option value="supporttekniker">Supporttekniker</option>
                        <option value="systemadministrator">Systemadministratör</option>
                        <option value="systemspecialist">Systemspecialist</option>
                    </select>
                </div>
            </div>

            <!-- SEKTION 2: GRUNDDATA -->
            <div class="section hidden" id="grunddataSection">
                <div class="section-title">Bakgrundsinformation</div>

                <div class="question">
                    <div class="question-text">Hur många års arbetslivserfarenhet har du inom ditt område?</div>
                    <input type="number" name="years_experience" min="0" max="50" step="0.5" required> år
                </div>
            </div>

            <!-- SEKTION 3: FRÅGOR (46 BLANDADE) -->
            <div class="section hidden" id="fragorSection">
                <div class="section-title">Kompetensbedömning</div>
                <div class="section-subtitle">
                    <strong>Viktigt:</strong> Varje påstående ska bedömas <u>individuellt</u> utifrån hur väl det överensstämmer med din situation.<br><br>
                    <strong>Exempel:</strong> Om du ser "Jag har expertkompetens" och "Jag har fördjupad kompetens":<br>
                    • Om du är expert: Sätt 4 på "expertkompetens" och 1-2 på "fördjupad kompetens"<br>
                    • Om du har fördjupad: Sätt 1-2 på "expertkompetens" och 4 på "fördjupad kompetens"<br><br>
                    <strong>Skala:</strong><br>
                    <strong>1</strong> = Stämmer inte alls &nbsp;|&nbsp; <strong>2</strong> = Stämmer delvis &nbsp;|&nbsp; 
                    <strong>3</strong> = Stämmer i hög grad &nbsp;|&nbsp; <strong>4</strong> = Stämmer helt
                </div>
                
                <table class="frequency-table">
                    <thead>
                        <tr>
                            <th class="freq-header" style="width: 50%;">Påstående</th>
                            <th class="freq-header">1</th>
                            <th class="freq-header">2</th>
                            <th class="freq-header">3</th>
                            <th class="freq-header">4</th>
                        </tr>
                    </thead>
                    <tbody id="fragor_tbody">
                        <!-- Frågor genereras här -->
                    </tbody>
                </table>
            </div>

            <button type="submit" class="submit-btn hidden" id="submitBtn">Beräkna min självskattning</button>
        </form>

        <div class="result-container" id="resultContainer">
            <!-- Resultat visas här -->
        </div>
    </div>

    <!-- Email status modal -->
    <div class="email-status-modal" id="emailStatusModal">
        <div class="email-status-content" id="emailStatusContent">
            <!-- Status visas här -->
        </div>
    </div>

    <!-- Dold rapport-container för PDF-generering -->
    <div id="pdfReportContainer" style="display: none; position: absolute; left: -9999px;">
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════
        // MSAL KONFIGURATION - DELEGERADE BEHÖRIGHETER
        // ═══════════════════════════════════════════════════════════
        
        const MSAL_CLIENT_ID = '363fccc8-2ebc-4423-8ecc-dea5f6f1d587';
        const MSAL_TENANT_ID = '78a88712-586a-44a3-b2d9-d0ed2b991cd2';
        
        const msalConfig = {
            auth: {
                clientId: MSAL_CLIENT_ID,
                authority: `https://login.microsoftonline.com/${MSAL_TENANT_ID}`,
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false
            }
        };

        let msalInstance = null;
        let currentUser = null;
        let managerInfo = null;

        // ═══════════════════════════════════════════════════════════
        // BEFATTNINGAR MED KORREKTA NIVÅER
        // ═══════════════════════════════════════════════════════════
        
        const BEFATTNINGAR = {
            it_produktforsorjning: { 
                namn: 'IT-produktförsörjning', 
                nivaer: [1, 2, 3],
                fraga: 'Vilket är ditt primära ansvarsområde?', 
                placeholder: 't.ex. IT-utrustning, tjänster' 
            },
            kundansvarig: { 
                namn: 'Kundansvarig', 
                nivaer: [2, 3],
                fraga: 'Vilka kundgrupper ansvarar du för?', 
                placeholder: 't.ex. förvaltningar' 
            },
            systemutvecklare: { 
                namn: 'Systemutvecklare', 
                nivaer: [1, 2, 3, 4], 
                fraga: 'Vilka teknologier arbetar du med?', 
                placeholder: 't.ex. .NET, React' 
            },
            natverkstekniker: { 
                namn: 'Nätverkstekniker', 
                nivaer: [1, 2, 3, 4], 
                fraga: 'Vilket nätverksområde?', 
                placeholder: 't.ex. LAN, WAN' 
            },
            it_projektledare: { 
                namn: 'IT Projektledare', 
                nivaer: [1, 2, 3, 4], 
                fraga: 'Vilken typ av projekt?', 
                placeholder: 't.ex. infrastruktur' 
            },
            supporttekniker: { 
                namn: 'Supporttekniker', 
                nivaer: [1, 2, 3],
                fraga: 'Vilken typ av support?', 
                placeholder: 't.ex. 1:a linje' 
            },
            systemadministrator: { 
                namn: 'Systemadministratör', 
                nivaer: [1, 2, 3, 4], 
                fraga: 'Vilka system?', 
                placeholder: 't.ex. Windows Server' 
            },
            systemspecialist: { 
                namn: 'Systemspecialist', 
                nivaer: [1, 2, 3, 4], 
                fraga: 'Vilket system?', 
                placeholder: 't.ex. ServiceNow' 
            }
        };

        // GEMENSAMMA FRÅGEPAR (17 par = 34 frågor)
        const GEMENSAMMA_PAR = [
            { id: 'gem_1', a: 'Jag tar egna tekniska beslut', b: 'Jag involverar min chef i tekniska beslut' },
            { id: 'gem_2', a: 'Jag granskar mitt arbete själv innan leverans', b: 'Min chef granskar mitt arbete innan leverans' },
            { id: 'gem_3', a: 'Jag informerar min chef om vad jag gör', b: 'Min chef informerar mig om vad jag ska göra' },
            { id: 'gem_4', a: 'Kollegor ber mig om teknisk input', b: 'Jag ber kollegor om teknisk input' },
            { id: 'gem_5', a: 'Jag skriver dokumentation för teamet', b: 'Andra skriver dokumentation för mitt arbete' },
            { id: 'gem_6', a: 'Jag hjälper andra att lära sig', b: 'Andra hjälper mig att lära mig' },
            { id: 'gem_7', a: 'Jag deltar i diskussioner om framtida riktning', b: 'Jag informeras om framtida riktning' },
            { id: 'gem_8', a: 'Jag leder projekt som påverkar många', b: 'Jag deltar i projekt som andra leder' },
            { id: 'gem_9', a: 'Jag löser de flesta problem själv', b: 'Jag eskalerar många problem vidare' },
            { id: 'gem_10', a: 'Jag får mål och bestämmer vägen själv', b: 'Jag får detaljerade instruktioner att följa' },
            { id: 'gem_11', a: 'Jag planerar mitt eget arbete', b: 'Någon annan planerar mitt arbete' },
            { id: 'gem_12', a: 'Jag föreslår lösningar till min chef', b: 'Min chef föreslår lösningar till mig' },
            { id: 'gem_13', a: 'Jag har deltagit i stora och komplexa uppdrag inom olika områden', b: 'Jag har deltagit i enklare och avgränsade uppdrag' },
            { id: 'gem_14', a: 'Jag har genomfört uppdrag med mycket hög kvalitet', b: 'Jag har genomfört uppdrag med grundläggande kvalitet' },
            { id: 'gem_15', a: 'Jag har grundläggande kompetens inom mitt område', b: 'Jag har begränsad kompetens inom mitt område' },
            { id: 'gem_16', a: 'Jag har fördjupad kompetens och har studerat omfattande på egen hand', b: 'Jag har grundläggande kompetens' },
            { id: 'gem_17', a: 'Jag har expertkompetens och är erkänd som expert', b: 'Jag har fördjupad kompetens' }
        ];
        
        // VALIDERINGS-FRÅGOR (5 enskilda, EJ par - mäter extern bekräftelse)
        const VALIDERINGS_FRAGOR = [
            { id: 'val_1', text: 'Kollegor söker aktivt min hjälp i komplexa frågor' },
            { id: 'val_2', text: 'Min chef delegerar viktiga beslut till mig' },
            { id: 'val_3', text: 'Jag får mandat att fatta beslut som påverkar andra team' },
            { id: 'val_4', text: 'Min kompetens lyfts fram när teamet/organisationen presenteras' },
            { id: 'val_5', text: 'Jag blir ombedd att mentorera eller utbilda andra' }
        ];

        // BEFATTNINGSSPECIFIKA PAR (6 par = 12 frågor per befattning)
        const SPECIFIKA_PAR = {
            it_produktforsorjning: [
                { id: 'spec_1', a: 'Jag hanterar beställningar självständigt', b: 'Jag behöver hjälp med beställningar' },
                { id: 'spec_2', a: 'Jag gör behovsanalys med kunder', b: 'Någon annan gör behovsanalys' },
                { id: 'spec_3', a: 'Jag ansvarar för upphandlingar', b: 'Jag deltar i upphandlingar' },
                { id: 'spec_4', a: 'Jag tar ekonomiskt ansvar för inköp', b: 'Jag följer budget från andra' },
                { id: 'spec_5', a: 'Jag utvecklar inköpsprocesser', b: 'Jag följer befintliga inköpsprocesser' },
                { id: 'spec_6', a: 'Jag förhandlar med leverantörer', b: 'Andra förhandlar med leverantörer' }
            ],
            kundansvarig: [
                { id: 'spec_1', a: 'Jag ansvarar för kundrelationer strategiskt', b: 'Jag hanterar kundrelationer operativt' },
                { id: 'spec_2', a: 'Jag driver Demand-processen', b: 'Jag deltar i Demand-processen' },
                { id: 'spec_3', a: 'Jag agerar Trusted Advisor', b: 'Jag förmedlar tjänster till kunder' },
                { id: 'spec_4', a: 'Jag identifierar nya tjänstebehov', b: 'Jag informerar om befintliga tjänster' },
                { id: 'spec_5', a: 'Jag driver förbättringsinitiativ', b: 'Jag rapporterar kundfeedback' },
                { id: 'spec_6', a: 'Jag deltar i strategiska dialoger med kundledning', b: 'Jag har operativa kundmöten' }
            ],
            systemutvecklare: [
                { id: 'spec_1', a: 'Jag skriver komplex kod självständigt', b: 'Jag skriver enkel kod med handledning' },
                { id: 'spec_2', a: 'Jag designar systemarkitektur', b: 'Jag implementerar andras design' },
                { id: 'spec_3', a: 'Jag leder tekniska diskussioner', b: 'Jag deltar i tekniska diskussioner' },
                { id: 'spec_4', a: 'Jag definierar tekniska standarder', b: 'Jag följer tekniska standarder' },
                { id: 'spec_5', a: 'Jag driver teknisk innovation', b: 'Jag bidrar till tekniska förbättringar' },
                { id: 'spec_6', a: 'Jag mentorar andra utvecklare', b: 'Jag lär mig av erfarna utvecklare' }
            ],
            natverkstekniker: [
                { id: 'spec_1', a: 'Jag installerar nätverksutrustning självständigt', b: 'Jag assisterar vid installation av nätverksutrustning' },
                { id: 'spec_2', a: 'Jag felsöker nätverksproblem utan hjälp', b: 'Jag ber om hjälp vid nätverksproblem' },
                { id: 'spec_3', a: 'Jag designar nätverksarkitektur', b: 'Jag implementerar andras nätverksdesign' },
                { id: 'spec_4', a: 'Jag skapar nätverksdokumentation', b: 'Jag följer befintlig nätverksdokumentation' },
                { id: 'spec_5', a: 'Jag planerar nätverkets framtida utveckling', b: 'Jag informeras om planer för nätverket' },
                { id: 'spec_6', a: 'Jag mentorerar andra inom nätverk', b: 'Jag lär mig nätverk av mer erfarna kollegor' }
            ],
            it_projektledare: [
                { id: 'spec_1', a: 'Jag leder projekt självständigt', b: 'Jag assisterar i projekt' },
                { id: 'spec_2', a: 'Jag hanterar projektbudgetar', b: 'Någon annan hanterar budgeten' },
                { id: 'spec_3', a: 'Jag leder flera projekt samtidigt', b: 'Jag arbetar med ett projekt åt gången' },
                { id: 'spec_4', a: 'Jag har portföljansvar', b: 'Jag ansvarar för enskilda projekt' },
                { id: 'spec_5', a: 'Jag utvecklar projektmetodik', b: 'Jag följer befintlig projektmetodik' },
                { id: 'spec_6', a: 'Jag samordnar resurser strategiskt', b: 'Jag samordnar resurser operativt' }
            ],
            supporttekniker: [
                { id: 'spec_1', a: 'Jag löser komplexa supportärenden', b: 'Jag löser enkla supportärenden' },
                { id: 'spec_2', a: 'Jag utför avancerad felsökning', b: 'Jag utför grundläggande felsökning' },
                { id: 'spec_3', a: 'Jag skapar KB-artiklar', b: 'Jag använder befintliga KB-artiklar' },
                { id: 'spec_4', a: 'Jag identifierar systemfel proaktivt', b: 'Jag hanterar inkommande ärenden' },
                { id: 'spec_5', a: 'Jag förbättrar supportprocesser', b: 'Jag följer supportprocesser' },
                { id: 'spec_6', a: 'Jag utbildar användare', b: 'Jag stöttar användare vid problem' }
            ],
            systemadministrator: [
                { id: 'spec_1', a: 'Jag designar systemlösningar', b: 'Jag implementerar systemlösningar' },
                { id: 'spec_2', a: 'Jag löser komplexa systemproblem', b: 'Jag löser grundläggande systemproblem' },
                { id: 'spec_3', a: 'Jag definierar tekniska strategier', b: 'Jag följer tekniska strategier' },
                { id: 'spec_4', a: 'Jag automatiserar med script', b: 'Jag kör befintliga script' },
                { id: 'spec_5', a: 'Jag leder tekniska projekt', b: 'Jag deltar i tekniska projekt' },
                { id: 'spec_6', a: 'Jag driver innovation', b: 'Jag bidrar till förbättringar' }
            ],
            systemspecialist: [
                { id: 'spec_1', a: 'Jag designar systemlösningar', b: 'Jag implementerar systemlösningar' },
                { id: 'spec_2', a: 'Jag löser komplexa problem från minnet', b: 'Jag kollar dokumentation vid problem' },
                { id: 'spec_3', a: 'Jag utvecklar strategier för systemet', b: 'Jag följer strategier för systemet' },
                { id: 'spec_4', a: 'Jag optimerar systemprestanda', b: 'Jag övervakar systemprestanda' },
                { id: 'spec_5', a: 'Jag leder systemrelaterade projekt', b: 'Jag deltar i systemrelaterade projekt' },
                { id: 'spec_6', a: 'Jag mentorerar andra om systemet', b: 'Jag lär mig systemet av andra' }
            ]
        };

        // ═══════════════════════════════════════════════════════════
        // MSAL INITIALIZATION & AUTH
        // ═══════════════════════════════════════════════════════════

        async function initializeMsal() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                console.log('MSAL initialiserad');
            } catch (error) {
                console.error('MSAL initialization error:', error);
            }
        }

        async function getGraphAccessToken(scopes = ['User.Read', 'User.Read.All']) {
            if (!msalInstance) {
                await initializeMsal();
            }

            const accounts = msalInstance.getAllAccounts();
            const loginRequest = {
                scopes: scopes,
                loginHint: currentUser?.email
            };
            
            if (accounts.length === 0) {
                console.log('Inga MSAL-konton, försöker popup-login');
                try {
                    const response = await msalInstance.loginPopup(loginRequest);
                    console.log('Popup-login lyckades');
                    return response.accessToken;
                } catch (popupError) {
                    console.log('Popup-login misslyckades:', popupError);
                    return null;
                }
            }

            try {
                const silentRequest = {
                    scopes: scopes,
                    account: accounts[0]
                };
                const response = await msalInstance.acquireTokenSilent(silentRequest);
                return response.accessToken;
            } catch (error) {
                console.log('Silent token acquisition misslyckades, försöker popup');
                try {
                    const response = await msalInstance.acquireTokenPopup(loginRequest);
                    return response.accessToken;
                } catch (popupError) {
                    console.log('Popup token acquisition misslyckades:', popupError);
                    return null;
                }
            }
        }

        // Hämta token för e-post (Mail.Send)
        async function getMailAccessToken() {
            return await getGraphAccessToken(['User.Read', 'Mail.Send']);
        }

        // ═══════════════════════════════════════════════════════════
        // USER INFO FETCHING
        // ═══════════════════════════════════════════════════════════

        async function fetchUserInfo() {
            try {
                // Först hämta grundläggande info från EasyAuth
                const authResponse = await fetch('/.auth/me');
                const authData = await authResponse.json();
                
                if (authData.clientPrincipal) {
                    currentUser = {
                        name: authData.clientPrincipal.userDetails,
                        email: authData.clientPrincipal.userDetails
                    };
                    
                    document.getElementById('userInfo').innerHTML = `
                        <span style="opacity: 0.8;">Inloggad som:</span> <strong>${currentUser.email}</strong>
                        <span style="opacity: 0.6; font-size: 0.9em;"> (hämtar mer info...)</span>
                    `;
                    
                    // Försök hämta mer detaljerad info via Graph API
                    await fetchGraphUserInfo();
                }
            } catch (error) {
                console.log('Kör lokalt eller utan auth:', error);
                document.getElementById('userInfo').innerHTML = `
                    <span style="opacity: 0.8;">Kör i testläge</span>
                `;
            }
        }

        async function fetchGraphUserInfo() {
            try {
                const accessToken = await getGraphAccessToken();
                
                if (!accessToken) {
                    console.log('Kunde inte få access token, visar endast grundläggande info');
                    document.getElementById('userInfo').innerHTML = `
                        <span style="opacity: 0.8;">Inloggad som:</span> <strong>${currentUser.email}</strong>
                    `;
                    return;
                }

                // Hämta användarprofil
                const userResponse = await fetch('https://graph.microsoft.com/v1.0/me?$select=displayName,mail,userPrincipalName', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    currentUser = {
                        name: userData.displayName,
                        email: userData.mail || userData.userPrincipalName
                    };
                }

                // Hämta chef
                const managerResponse = await fetch('https://graph.microsoft.com/v1.0/me/manager?$select=displayName,mail,userPrincipalName', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                let managerStatusMsg = '';
                if (managerResponse.ok) {
                    const managerData = await managerResponse.json();
                    managerInfo = {
                        name: managerData.displayName,
                        email: managerData.mail || managerData.userPrincipalName
                    };
                    console.log('Chef hämtad:', managerInfo);
                } else if (managerResponse.status === 403) {
                    console.log('403 - Ingen behörighet att läsa manager');
                    managerStatusMsg = '<br><span style="opacity: 0.6; font-size: 0.85em;">⚠️ Chef-info kräver ytterligare behörigheter</span>';
                } else if (managerResponse.status === 404) {
                    console.log('404 - Ingen chef registrerad i systemet');
                }

                // Uppdatera UI
                let userInfoHtml = `<span style="opacity: 0.8;">Inloggad som:</span> <strong>${currentUser.name}</strong> (${currentUser.email})`;
                
                if (managerInfo) {
                    userInfoHtml += `<br><span style="opacity: 0.8;">Chef:</span> <strong>${managerInfo.name}</strong> (${managerInfo.email})`;
                } else if (managerStatusMsg) {
                    userInfoHtml += managerStatusMsg;
                }
                
                document.getElementById('userInfo').innerHTML = userInfoHtml;

            } catch (error) {
                console.error('Graph API fel:', error);
                if (currentUser) {
                    document.getElementById('userInfo').innerHTML = `
                        <span style="opacity: 0.8;">Inloggad som:</span> <strong>${currentUser.email}</strong>
                    `;
                }
            }
        }

        // ═══════════════════════════════════════════════════════════
        // EVENT HANDLERS
        // ═══════════════════════════════════════════════════════════

        const form = document.getElementById('assessmentForm');
        const befattningSelect = document.getElementById('befattningSelect');

        befattningSelect.addEventListener('change', function() {
            const befattning = this.value;
            if (!befattning) return;

            document.getElementById('grunddataSection').classList.remove('hidden');
            document.getElementById('fragorSection').classList.remove('hidden');
            document.getElementById('submitBtn').classList.remove('hidden');

            laddaBlandadeFragor(befattning);

            document.getElementById('grunddataSection').scrollIntoView({ behavior: 'smooth' });
        });

        function laddaBlandadeFragor(befattning) {
            const gemensamma = [];
            GEMENSAMMA_PAR.forEach(par => {
                gemensamma.push({ id: par.id + 'a', text: par.a, parId: par.id, type: 'a' });
                gemensamma.push({ id: par.id + 'b', text: par.b, parId: par.id, type: 'b' });
            });

            const specifika = [];
            if (SPECIFIKA_PAR[befattning]) {
                SPECIFIKA_PAR[befattning].forEach(par => {
                    specifika.push({ id: par.id + 'a', text: par.a, parId: par.id, type: 'a' });
                    specifika.push({ id: par.id + 'b', text: par.b, parId: par.id, type: 'b' });
                });
            }
            
            const validering = [];
            VALIDERINGS_FRAGOR.forEach(fraga => {
                validering.push({ id: fraga.id, text: fraga.text, type: 'validering' });
            });

            // BLANDA ALLT
            const allaFragor = [...gemensamma, ...specifika, ...validering];
            allaFragor.sort(() => Math.random() - 0.5);

            const tbody = document.getElementById('fragor_tbody');
            tbody.innerHTML = allaFragor.map(q => `
                <tr class="freq-row">
                    <td class="freq-label">${q.text}</td>
                    <td class="freq-cell"><input type="radio" name="${q.id}" value="1" required></td>
                    <td class="freq-cell"><input type="radio" name="${q.id}" value="2"></td>
                    <td class="freq-cell"><input type="radio" name="${q.id}" value="3"></td>
                    <td class="freq-cell"><input type="radio" name="${q.id}" value="4"></td>
                </tr>
            `).join('');

            tbody.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', uppdateraProgress);
            });
        }

        function uppdateraProgress() {
            const radioGroups = new Set();
            form.querySelectorAll('input[type="radio"]').forEach(r => radioGroups.add(r.name));
            
            let completed = 0;
            radioGroups.forEach(group => {
                if (form.querySelector(`input[name="${group}"]:checked`)) completed++;
            });

            const requiredInputs = form.querySelectorAll('input[required][type="text"], input[required][type="number"]');
            let totalRequired = radioGroups.size + requiredInputs.length;
            requiredInputs.forEach(input => {
                if (input.value.trim() !== '') completed++;
            });

            const percentage = Math.round((completed / totalRequired) * 100);
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        // ═══════════════════════════════════════════════════════════
        // FORM SUBMISSION
        // ═══════════════════════════════════════════════════════════

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const befattning = befattningSelect.value;
            const formData = new FormData(form);
            const answers = {};
            
            for (let [key, value] of formData.entries()) {
                answers[key] = value;
            }

            const result = beraknaNiva(befattning, answers);
            visaResultat(befattning, result, answers);
            
            // Skicka automatiskt e-post med rapport till användare och chef
            setTimeout(() => {
                skickaEmailMedPDF();
            }, 500);
        });

        function beraknaNiva(befattning, answers) {
            const info = BEFATTNINGAR[befattning];
            const warnings = [];
            const parScores = [];

            const ledningScores = [];
            const erfarenhetKvalitetScores = [];
            const kunskapScores = [];
            
            GEMENSAMMA_PAR.forEach((par, index) => {
                const valA = parseInt(answers[par.id + 'a'] || 2.5);
                const valB = parseInt(answers[par.id + 'b'] || 2.5);
                const diff = Math.abs(valA - valB);
                const score = (valA - valB + 5) / 2;
                
                if (par.id === 'gem_13' || par.id === 'gem_14') {
                    erfarenhetKvalitetScores.push(score);
                } else if (par.id === 'gem_15' || par.id === 'gem_16' || par.id === 'gem_17') {
                    kunskapScores.push(score);
                } else {
                    ledningScores.push(score);
                }
                
                parScores.push(score);

                if (diff <= 1) {
                    warnings.push(`Misstänkt svar på: "${par.a}" / "${par.b}" (${valA}/${valB})`);
                }
            });

            const operational = (ledningScores[9] + ledningScores[10]) / 2;
            const autonomous = (ledningScores[0] + ledningScores[1] + ledningScores[2] + ledningScores[8] + ledningScores[11]) / 5;
            const expert = (ledningScores[3] + ledningScores[4] + ledningScores[5]) / 3;
            const strategic = (ledningScores[6] + ledningScores[7]) / 2;

            const minNiva = Math.min(...info.nivaer);
            const maxNiva = Math.max(...info.nivaer);

            let befattningNiva = minNiva;
            
            if (befattning === 'kundansvarig') {
                if (strategic >= 3.2 && expert >= 3.2 && autonomous >= 2.9) {
                    befattningNiva = 3;
                } else {
                    befattningNiva = 2;
                }
            } else if (befattning === 'it_produktforsorjning' || befattning === 'supporttekniker') {
                if (expert >= 3.2 && autonomous >= 2.9 && operational >= 2.5) {
                    befattningNiva = 3;
                } else if (autonomous >= 2.2 && operational >= 1.8) {
                    befattningNiva = 2;
                } else {
                    befattningNiva = 1;
                }
            } else {
                if (strategic >= 3.4 && expert >= 3.4 && autonomous >= 3.0 && operational >= 3.0) {
                    befattningNiva = 4;
                } else if (expert >= 3.0 && autonomous >= 2.8 && operational >= 2.5) {
                    befattningNiva = 3;
                } else if (autonomous >= 2.2 && operational >= 1.8) {
                    befattningNiva = 2;
                } else {
                    befattningNiva = 1;
                }
            }
            befattningNiva = Math.max(minNiva, Math.min(maxNiva, befattningNiva));

            // Erfarenhet
            const years = parseFloat(answers.years_experience);
            const komplexScore = (parseInt(answers.gem_13a || 2.5) - parseInt(answers.gem_13b || 2.5) + 5) / 2;
            const kvalitetScore = (parseInt(answers.gem_14a || 2.5) - parseInt(answers.gem_14b || 2.5) + 5) / 2;
            
            let erfarenhetNiva = minNiva;
            
            if (years >= 8 && maxNiva >= 4 && komplexScore >= 3.0 && kvalitetScore >= 3.0) {
                erfarenhetNiva = 4;
            } else if (years >= 4 && maxNiva >= 3 && (komplexScore >= 3.0 || kvalitetScore >= 3.0)) {
                erfarenhetNiva = 3;
            } else if (years >= 2 && maxNiva >= 2) {
                erfarenhetNiva = 2;
            } else {
                erfarenhetNiva = minNiva;
            }
            erfarenhetNiva = Math.max(minNiva, Math.min(maxNiva, erfarenhetNiva));

            // Kunskap
            const grundScore = (parseInt(answers.gem_15a || 2.5) - parseInt(answers.gem_15b || 2.5) + 5) / 2;
            const fordjupadScore = (parseInt(answers.gem_16a || 2.5) - parseInt(answers.gem_16b || 2.5) + 5) / 2;
            const expertScore = (parseInt(answers.gem_17a || 2.5) - parseInt(answers.gem_17b || 2.5) + 5) / 2;
            
            let kunskapNiva = minNiva;
            
            if (expertScore >= 3.0 && maxNiva >= 4) {
                kunskapNiva = 4;
            } else if (fordjupadScore >= 3.0 && maxNiva >= 3) {
                kunskapNiva = 3;
            } else if (grundScore >= 3.0 && maxNiva >= 2) {
                kunskapNiva = 2;
            } else {
                kunskapNiva = minNiva;
            }
            kunskapNiva = Math.max(minNiva, Math.min(maxNiva, kunskapNiva));

            // Ledningsbehov
            const autoScore = (ledningScores[0] + ledningScores[1] + ledningScores[2]) / 3;
            let ledningsbehovNiva = minNiva;
            
            if (befattning === 'kundansvarig') {
                if (autoScore >= 2.8) ledningsbehovNiva = 3;
                else ledningsbehovNiva = 2;
            } else if (befattning === 'it_produktforsorjning' || befattning === 'supporttekniker') {
                if (autoScore >= 2.6) ledningsbehovNiva = 3;
                else if (autoScore >= 1.8) ledningsbehovNiva = 2;
                else ledningsbehovNiva = 1;
            } else {
                if (autoScore >= 3.0) ledningsbehovNiva = 4;
                else if (autoScore >= 2.4) ledningsbehovNiva = 3;
                else if (autoScore >= 1.8) ledningsbehovNiva = 2;
                else ledningsbehovNiva = 1;
            }
            ledningsbehovNiva = Math.max(minNiva, Math.min(maxNiva, ledningsbehovNiva));
            
            // EXTERN VALIDERING
            const valideringsScores = [];
            VALIDERINGS_FRAGOR.forEach(fraga => {
                const val = parseInt(answers[fraga.id] || 2.5);
                valideringsScores.push(val);
            });
            const valideringsScore = valideringsScores.reduce((a, b) => a + b, 0) / valideringsScores.length;
            
            const självbedomningScore = autonomous;
            const diskrepans = Math.abs(självbedomningScore - valideringsScore);
            
            const sanityWarnings = [];
            if (diskrepans > 1.0) {
                sanityWarnings.push({
                    typ: 'Diskrepans mellan självbild och extern validering',
                    självbedomning: självbedomningScore.toFixed(2),
                    validering: valideringsScore.toFixed(2),
                    beskrivning: självbedomningScore > valideringsScore 
                        ? 'Din självbedömning är högre än vad extern validering tyder på'
                        : 'Extern validering tyder på högre kompetens än din självbedömning'
                });
            }

            // Flaskhals
            let finalLevel = Math.min(befattningNiva, kunskapNiva, erfarenhetNiva, ledningsbehovNiva);

            if (!info.nivaer.includes(finalLevel)) {
                finalLevel = info.nivaer.reduce((prev, curr) => {
                    return Math.abs(curr - finalLevel) < Math.abs(prev - finalLevel) ? curr : prev;
                });
            }

            const bottlenecks = [];
            if (befattningNiva === finalLevel) bottlenecks.push('Befattningsbeskrivning');
            if (kunskapNiva === finalLevel) bottlenecks.push('Kunskapskrav');
            if (erfarenhetNiva === finalLevel) bottlenecks.push('Erfarenhetskrav');
            if (ledningsbehovNiva === finalLevel) bottlenecks.push('Ledningsbehov');

            const score = Math.round((finalLevel / maxNiva) * 100);

            return {
                level: finalLevel,
                breakdown: { befattning: befattningNiva, kunskap: kunskapNiva, erfarenhet: erfarenhetNiva, ledningsbehov: ledningsbehovNiva },
                bottlenecks,
                score,
                warnings,
                validering: {
                    score: valideringsScore,
                    självbedomning: självbedomningScore,
                    diskrepans: diskrepans,
                    sanityWarnings: sanityWarnings
                }
            };
        }

        function visaResultat(befattning, result, answers) {
            const info = BEFATTNINGAR[befattning];
            const nivaInfo = {
                1: { 
                    titel: 'NIVÅ 1 - Operativ', 
                    beskrivning: 'Grundläggande uppgifter under övervakning',
                    ledning: 'Instruktion - Får specifika och detaljerade instruktioner'
                },
                2: { 
                    titel: 'NIVÅ 2 - Operativ-Taktisk', 
                    beskrivning: 'Självständigt arbete med rådgivning',
                    ledning: 'Rådgivning - Arbetar självständigt med stöd vid behov'
                },
                3: { 
                    titel: 'NIVÅ 3 - Operativ-Taktisk-Strategisk', 
                    beskrivning: 'Teknisk expert och mentor',
                    ledning: 'Coaching - Identifierar behov och driver lösningar'
                },
                4: { 
                    titel: 'NIVÅ 4 - Strategisk', 
                    beskrivning: 'Driver strategisk utveckling',
                    ledning: 'Strategisk - Definierar målbilder och leder grupper'
                }
            };

            const niva = nivaInfo[result.level];
            const maxNiva = Math.max(...info.nivaer);
            const minNiva = Math.min(...info.nivaer);
            
            // SANITY CHECK VARNINGAR
            let sanityHTML = '';
            if (result.validering && result.validering.sanityWarnings.length > 0) {
                sanityHTML = `
                    <div style="background: rgba(255, 215, 0, 0.25); border-left: 4px solid var(--warning); padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                        <strong style="display: block; font-size: 1.3em; margin-bottom: 15px;">⚠️ Diskrepans upptäckt</strong>
                        ${result.validering.sanityWarnings.map(w => `
                            <div style="margin-bottom: 15px;">
                                <p style="margin-bottom: 10px;"><strong>${w.typ}</strong></p>
                                <p style="margin-bottom: 10px;">${w.beskrivning}</p>
                                <div style="display: flex; gap: 30px; margin-top: 10px;">
                                    <div><strong>Din självbedömning:</strong> ${w.självbedomning}/4.0</div>
                                    <div><strong>Extern validering:</strong> ${w.validering}/4.0</div>
                                </div>
                            </div>
                        `).join('')}
                        <p style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.3); font-style: italic;">
                            <strong>Vad betyder detta?</strong><br>
                            Det kan finnas en skillnad mellan hur du ser dig själv och hur andra upplever dig i din roll. 
                            Detta är vanligt och inget att oroa sig för - diskutera gärna med din chef för att få en gemensam bild.
                        </p>
                    </div>
                `;
            }

            // VARNINGAR
            let warningsHTML = '';
            if (result.warnings && result.warnings.length > 0) {
                warningsHTML = `
                    <div style="background: rgba(255, 152, 0, 0.2); border-left: 4px solid #ff9800; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                        <strong style="display: block; font-size: 1.2em; margin-bottom: 15px;">⚠️ Observera följande:</strong>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            ${result.warnings.slice(0, 3).map(w => `<li>${w}</li>`).join('')}
                        </ul>
                        <p style="margin-top: 15px; font-style: italic;">
                            Detta påverkar inte din beräknade nivå, men kan vara värt att diskutera med din chef.
                        </p>
                    </div>
                `;
            }

            const html = `
                <div class="result-warning">
                    <strong>⚠️ Detta är en självskattning</strong>
                    Resultatet nedan är baserat på dina egna svar och används som underlag för dialog med din chef. 
                    Din chef gör den officiella bedömningen enligt organisationens nivåkriterier.
                </div>

                ${sanityHTML}
                ${warningsHTML}

                <div class="score-circle">
                    <div class="score-number">${result.score}</div>
                    <div class="score-total">/100</div>
                </div>

                <div class="result-level">${niva.titel}</div>
                <div class="result-desc">${info.namn} - ${niva.beskrivning}</div>
                <p style="text-align: center; opacity: 0.9; margin-top: 10px;">${niva.ledning}</p>

                <div class="result-breakdown">
                    <h3 style="margin-bottom: 30px; font-size: 1.8em;">📊 Bedömning enligt 4 kriterier</h3>
                    
                    <div class="breakdown-item">
                        <div class="breakdown-label">
                            <strong>1. Befattningsbeskrivning</strong>
                            <span>Vad du faktiskt gör i din vardag</span>
                        </div>
                        <div class="breakdown-value">
                            Nivå ${result.breakdown.befattning}
                            ${result.breakdown.befattning === result.level ? '<span class="breakdown-bottleneck">← FLASKHALS</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="breakdown-item">
                        <div class="breakdown-label">
                            <strong>2. Kunskapskrav</strong>
                            <span>Certifieringar/kompetens</span>
                        </div>
                        <div class="breakdown-value">
                            Nivå ${result.breakdown.kunskap}
                            ${result.breakdown.kunskap === result.level ? '<span class="breakdown-bottleneck">← FLASKHALS</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="breakdown-item">
                        <div class="breakdown-label">
                            <strong>3. Erfarenhetskrav</strong>
                            <span>${answers.years_experience} år + kvalitet/komplexitet</span>
                        </div>
                        <div class="breakdown-value">
                            Nivå ${result.breakdown.erfarenhet}
                            ${result.breakdown.erfarenhet === result.level ? '<span class="breakdown-bottleneck">← FLASKHALS</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="breakdown-item">
                        <div class="breakdown-label">
                            <strong>4. Ledningsbehov</strong>
                            <span>Grad av självständighet</span>
                        </div>
                        <div class="breakdown-value">
                            Nivå ${result.breakdown.ledningsbehov}
                            ${result.breakdown.ledningsbehov === result.level ? '<span class="breakdown-bottleneck">← FLASKHALS</span>' : ''}
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding: 30px; background: rgba(255,255,255,0.15); border-radius: 10px;">
                        <strong style="font-size: 1.3em; display: block; margin-bottom: 15px;">🔒 Flaskhalsprincipen</strong>
                        <p style="line-height: 1.8; margin-bottom: 15px;">
                            För att nå en nivå måste <strong>ALLA fyra kriterier</strong> vara uppfyllda. 
                            Den lägsta nivån avgör din totala nivå.
                        </p>
                        <p style="margin-top: 15px; font-size: 1.1em;">
                            Din bedömning: <strong style="font-size: 1.2em;">${result.breakdown.befattning}-${result.breakdown.kunskap}-${result.breakdown.erfarenhet}-${result.breakdown.ledningsbehov}</strong>
                        </p>
                        <p style="margin-top: 10px; font-size: 1.2em;">
                            = <strong>NIVÅ ${result.level}</strong> av ${maxNiva} möjliga
                            ${minNiva > 1 ? ` (${info.namn} startar på nivå ${minNiva})` : ''}
                        </p>
                        ${result.bottlenecks.length > 0 ? 
                            `<p style="margin-top: 15px;">Begränsande: <strong>${result.bottlenecks.join(', ')}</strong></p>` 
                            : '<p style="margin-top: 15px;">✅ Alla kriterier är balanserade!</p>'}
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 25px; background: rgba(255,255,255,0.15); border-radius: 10px; text-align: center;">
                    <strong style="font-size: 1.2em; display: block; margin-bottom: 10px;">Nästa steg</strong>
                    <p style="line-height: 1.7;">
                        Boka in ett möte med din chef för att diskutera din självskattning.<br>
                        Ta med denna rapport och er gemensamma bedömning blir underlag för din utvecklingsplan.
                    </p>
                </div>

                <div class="action-buttons">
                    <button class="email-btn" onclick="skickaEmailMedPDF()">
                        📧 Skicka rapport via e-post
                    </button>
                    <button class="email-btn" onclick="laddaNerPDF()">
                        📄 Ladda ner som PDF
                    </button>
                </div>
            `;

            const container = document.getElementById('resultContainer');
            container.innerHTML = html;
            container.classList.add('show');
            container.scrollIntoView({ behavior: 'smooth' });

            // Spara data för email-rapport
            window.currentAssessment = { befattning, result, answers };
        }

        // ═══════════════════════════════════════════════════════════
        // PDF GENERATION
        // ═══════════════════════════════════════════════════════════

        function getSvarText(value) {
            const labels = {
                '1': 'Instämmer helt med A',
                '2': 'Instämmer delvis med A', 
                '3': 'Neutral',
                '4': 'Instämmer delvis med B',
                '5': 'Instämmer helt med B'
            };
            return labels[value] || value;
        }

        function genereraRapportHTML() {
            const { befattning, result, answers } = window.currentAssessment;
            const info = BEFATTNINGAR[befattning];
            const specifika = SPECIFIKA_PAR[befattning] || [];
            
            const nivaInfo = {
                1: { titel: 'NIVÅ 1 - Operativ', beskrivning: 'Grundläggande uppgifter under övervakning' },
                2: { titel: 'NIVÅ 2 - Operativ-Taktisk', beskrivning: 'Självständigt arbete med rådgivning' },
                3: { titel: 'NIVÅ 3 - Operativ-Taktisk-Strategisk', beskrivning: 'Teknisk expert och mentor' },
                4: { titel: 'NIVÅ 4 - Strategisk', beskrivning: 'Driver strategisk utveckling' }
            };

            const niva = nivaInfo[result.level];
            const datum = new Date().toLocaleDateString('sv-SE', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Generera HTML för gemensamma frågepar
            let gemensommaHTML = '';
            GEMENSAMMA_PAR.forEach((par, index) => {
                const valA = answers[par.id + 'a'];
                const valB = answers[par.id + 'b'];
                gemensommaHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: ${index % 2 === 0 ? '#f9f9f9' : '#fff'}; border-radius: 4px;">
                        <div style="font-weight: bold; color: #2d3561; margin-bottom: 5px;">Fråga ${index + 1}</div>
                        <div style="display: flex; margin-bottom: 4px;">
                            <span style="color: #666; min-width: 25px;">A:</span>
                            <span>${par.a}</span>
                            <span style="margin-left: auto; font-weight: bold; color: #2d3561;">${valA || '-'}</span>
                        </div>
                        <div style="display: flex;">
                            <span style="color: #666; min-width: 25px;">B:</span>
                            <span>${par.b}</span>
                            <span style="margin-left: auto; font-weight: bold; color: #2d3561;">${valB || '-'}</span>
                        </div>
                    </div>
                `;
            });

            // Generera HTML för specifika frågepar
            let specifikaHTML = '';
            specifika.forEach((par, index) => {
                const valA = answers[par.id + 'a'];
                const valB = answers[par.id + 'b'];
                specifikaHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: ${index % 2 === 0 ? '#f9f9f9' : '#fff'}; border-radius: 4px;">
                        <div style="font-weight: bold; color: #2d3561; margin-bottom: 5px;">Fråga ${index + 1}</div>
                        <div style="display: flex; margin-bottom: 4px;">
                            <span style="color: #666; min-width: 25px;">A:</span>
                            <span>${par.a}</span>
                            <span style="margin-left: auto; font-weight: bold; color: #2d3561;">${valA || '-'}</span>
                        </div>
                        <div style="display: flex;">
                            <span style="color: #666; min-width: 25px;">B:</span>
                            <span>${par.b}</span>
                            <span style="margin-left: auto; font-weight: bold; color: #2d3561;">${valB || '-'}</span>
                        </div>
                    </div>
                `;
            });

            // Generera HTML för valideringsfrågor
            let valideringHTML = '';
            VALIDERINGS_FRAGOR.forEach((fraga, index) => {
                const val = answers[fraga.id];
                valideringHTML += `
                    <div style="margin-bottom: 8px; padding: 8px; background: ${index % 2 === 0 ? '#f9f9f9' : '#fff'}; border-radius: 4px; display: flex; justify-content: space-between;">
                        <span>${fraga.text}</span>
                        <span style="font-weight: bold; color: #2d3561; min-width: 30px; text-align: right;">${val || '-'}</span>
                    </div>
                `;
            });

            return `
                <div style="font-family: Arial, sans-serif; padding: 30px; color: #333; background: #fff;">
                    <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #2d3561;">
                        <h1 style="color: #2d3561; font-size: 24px; margin: 0 0 10px 0;">Självskattning - Kompetensbedömning IT-service</h1>
                        <p style="color: #666; font-size: 14px; margin: 5px 0;">Rapport genererad: ${datum}</p>
                        ${currentUser ? `<p style="color: #666; font-size: 14px; margin: 5px 0;">Medarbetare: ${currentUser.name} (${currentUser.email})</p>` : ''}
                        ${managerInfo ? `<p style="color: #666; font-size: 14px; margin: 5px 0;">Chef: ${managerInfo.name} (${managerInfo.email})</p>` : ''}
                    </div>

                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 25px;">
                        <strong>⚠️ Viktigt:</strong> Detta är en självskattning som används som underlag för dialog med din chef.
                    </div>

                    <div style="background: #f5f5f5; padding: 20px; margin-bottom: 25px; border-radius: 8px;">
                        <h2 style="color: #2d3561; margin: 0 0 15px 0; font-size: 18px;">📋 Grunddata</h2>
                        <p style="margin: 8px 0;"><strong>Befattning:</strong> ${info.namn}</p>
                        <p style="margin: 8px 0;"><strong>Erfarenhet:</strong> ${answers.years_experience} år</p>
                    </div>

                    <div style="background: #2d3561; color: white; padding: 25px; margin-bottom: 25px; border-radius: 8px;">
                        <h2 style="margin: 0 0 15px 0; text-align: center; font-size: 18px;">🎯 Resultat</h2>
                        <div style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 10px;">${niva.titel}</div>
                        <div style="text-align: center; opacity: 0.9;">${info.namn} - ${niva.beskrivning}</div>
                        
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="text-align: center; padding: 10px; width: 25%;">
                                        <div style="font-size: 24px; font-weight: bold;">${result.breakdown.befattning}</div>
                                        <div style="font-size: 11px; opacity: 0.8;">Befattning</div>
                                    </td>
                                    <td style="text-align: center; padding: 10px; width: 25%;">
                                        <div style="font-size: 24px; font-weight: bold;">${result.breakdown.kunskap}</div>
                                        <div style="font-size: 11px; opacity: 0.8;">Kunskap</div>
                                    </td>
                                    <td style="text-align: center; padding: 10px; width: 25%;">
                                        <div style="font-size: 24px; font-weight: bold;">${result.breakdown.erfarenhet}</div>
                                        <div style="font-size: 11px; opacity: 0.8;">Erfarenhet</div>
                                    </td>
                                    <td style="text-align: center; padding: 10px; width: 25%;">
                                        <div style="font-size: 24px; font-weight: bold;">${result.breakdown.ledningsbehov}</div>
                                        <div style="font-size: 11px; opacity: 0.8;">Ledningsbehov</div>
                                    </td>
                                </tr>
                            </table>
                            <div style="margin-top: 15px; text-align: center; font-size: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                                <strong>Flaskhalsprincipen:</strong> ${result.breakdown.befattning}-${result.breakdown.kunskap}-${result.breakdown.erfarenhet}-${result.breakdown.ledningsbehov} = NIVÅ ${result.level}
                                ${result.bottlenecks.length > 0 ? `<br>Begränsande: ${result.bottlenecks.join(', ')}` : ''}
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #2d3561; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #2d3561;">📝 Gemensamma frågor (${GEMENSAMMA_PAR.length} par)</h2>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Skala: 1 = Instämmer helt med A, 3 = Neutral, 5 = Instämmer helt med B</p>
                        ${gemensommaHTML}
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #2d3561; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #2d3561;">💼 Befattningsspecifika frågor - ${info.namn} (${specifika.length} par)</h2>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Skala: 1 = Instämmer helt med A, 3 = Neutral, 5 = Instämmer helt med B</p>
                        ${specifikaHTML}
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #2d3561; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #2d3561;">📊 Övriga bedömningsfrågor</h2>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Skala: 1 = Instämmer inte alls, 5 = Instämmer helt</p>
                        ${valideringHTML}
                    </div>

                    <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <h3 style="color: #2e7d32; margin: 0 0 10px 0; font-size: 16px;">📌 Nästa steg</h3>
                        <p style="margin: 0; color: #1b5e20;">Boka in ett möte med din chef för att diskutera din självskattning. Er gemensamma bedömning blir underlag för din utvecklingsplan.</p>
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center;">
                        <p style="margin: 0; font-size: 11px; color: #999;">Kompetensbedömning IT-service • ${datum}</p>
                    </div>
                </div>
            `;
        }

        async function genereraPDF() {
            const { jsPDF } = window.jspdf;
            
            // Skapa en temporär div med rapporten
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = genereraRapportHTML();
            tempDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 794px;
                background: #ffffff;
                padding: 0;
                margin: 0;
                z-index: 99999;
            `;
            document.body.appendChild(tempDiv);

            // Vänta på att DOM ska uppdateras
            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                // Använd html2canvas för att rendera HTML till canvas
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: 794,
                    windowWidth: 794
                });

                // Ta bort temporär div
                document.body.removeChild(tempDiv);

                // Skapa PDF från canvas med stöd för flera sidor
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth;
                const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                
                // Hantera flera sidor om innehållet är längre än en A4
                let heightLeft = imgHeight;
                let position = 0;
                const pageHeight = pdfHeight;

                // Första sidan
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Lägg till fler sidor om det behövs
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const pdfBlob = pdf.output('blob');
                console.log('PDF blob size:', pdfBlob.size);
                return pdfBlob;
                
            } catch (error) {
                document.body.removeChild(tempDiv);
                console.error('PDF generation error:', error);
                throw error;
            }
        }

        async function laddaNerPDF() {
            try {
                showEmailStatus('Genererar PDF...', true);
                const pdfBlob = await genereraPDF();
                
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kompetensbedömning_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                hideEmailStatus();
            } catch (error) {
                showEmailStatus('❌ Kunde inte generera PDF: ' + error.message, false, true);
            }
        }

        // ═══════════════════════════════════════════════════════════
        // EMAIL SENDING VIA GRAPH API (DELEGATED)
        // ═══════════════════════════════════════════════════════════

        function showEmailStatus(message, showSpinner = false, showClose = false) {
            const modal = document.getElementById('emailStatusModal');
            const content = document.getElementById('emailStatusContent');
            
            content.innerHTML = `
                <h2>${showSpinner ? '📧 Skickar e-post...' : message.includes('✅') ? '✅ Klart!' : '⚠️ Status'}</h2>
                ${showSpinner ? '<div class="spinner"></div>' : ''}
                <p>${message}</p>
                ${showClose ? '<button onclick="hideEmailStatus()">Stäng</button>' : ''}
            `;
            
            modal.classList.add('show');
        }

        function hideEmailStatus() {
            document.getElementById('emailStatusModal').classList.remove('show');
        }

        async function skickaEmailMedPDF() {
            if (!window.currentAssessment) {
                alert('Ingen bedömning att skicka!');
                return;
            }

            if (!currentUser?.email) {
                alert('Kunde inte hitta din e-postadress. Kontrollera att du är inloggad.');
                return;
            }

            showEmailStatus('Hämtar behörigheter för e-post...', true);

            try {
                // Hämta token med Mail.Send behörighet
                const accessToken = await getMailAccessToken();
                
                if (!accessToken) {
                    showEmailStatus('❌ Kunde inte få behörighet att skicka e-post. Du kan behöva godkänna i popup-fönstret.', false, true);
                    return;
                }

                showEmailStatus('Genererar PDF-rapport...', true);
                const pdfBlob = await genereraPDF();
                
                // Konvertera PDF till base64
                const base64PDF = await blobToBase64(pdfBlob);

                showEmailStatus('Skickar e-post...', true);

                const { befattning, result, answers } = window.currentAssessment;
                const info = BEFATTNINGAR[befattning];
                const datum = new Date().toLocaleDateString('sv-SE');

                // Bygg mottagarlista
                const toRecipients = [
                    { emailAddress: { address: currentUser.email } }
                ];

                // Lägg till chef som mottagare om tillgänglig
                if (managerInfo?.email) {
                    toRecipients.push({ emailAddress: { address: managerInfo.email } });
                }

                const nivaInfo = {
                    1: 'NIVÅ 1 - Operativ',
                    2: 'NIVÅ 2 - Operativ-Taktisk',
                    3: 'NIVÅ 3 - Operativ-Taktisk-Strategisk',
                    4: 'NIVÅ 4 - Strategisk'
                };

                // Skapa e-postmeddelande (utan PDF-bilaga)
                const emailMessage = {
                    message: {
                        subject: `Självskattning - Kompetensbedömning: ${info.namn} - ${datum}`,
                        body: {
                            contentType: 'HTML',
                            content: `
                                <html>
                                <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                                    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                                        <h1 style="color: #2d3561; border-bottom: 3px solid #ff6b35; padding-bottom: 10px;">
                                            Självskattning - Kompetensbedömning IT-service
                                        </h1>
                                        
                                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">
                                            <strong>⚠️ Viktigt:</strong> Detta är en självskattning som används som underlag för dialog. 
                                            Chefen gör den officiella bedömningen.
                                        </div>
                                        
                                        <h2 style="color: #2d3561;">📋 Sammanfattning</h2>
                                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                                            <tr><td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>Medarbetare:</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${currentUser.name}</td></tr>
                                            <tr><td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>Befattning:</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${info.namn}</td></tr>
                                            <tr><td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>Erfarenhet:</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${answers.years_experience} år</td></tr>
                                            <tr><td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>Datum:</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${datum}</td></tr>
                                        </table>
                                        
                                        <div style="background: #2d3561; color: white; padding: 25px; border-radius: 10px; margin: 20px 0;">
                                            <h2 style="margin: 0 0 15px 0; text-align: center; color: white;">🎯 Självskattningsresultat</h2>
                                            <div style="text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 10px;">${nivaInfo[result.level]}</div>
                                            <div style="text-align: center; opacity: 0.9;">Bedömning: ${result.breakdown.befattning}-${result.breakdown.kunskap}-${result.breakdown.erfarenhet}-${result.breakdown.ledningsbehov}</div>
                                            ${result.bottlenecks.length > 0 ? `<div style="text-align: center; margin-top: 10px; font-size: 14px;">Begränsande: ${result.bottlenecks.join(', ')}</div>` : ''}
                                        </div>

                                        <h3 style="color: #2d3561;">📊 Bedömning per kriterium</h3>
                                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                                            <tr style="background: #f5f5f5;">
                                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>Befattningsbeskrivning</strong></td>
                                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 18px; font-weight: bold;">Nivå ${result.breakdown.befattning}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>Kunskapskrav</strong></td>
                                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 18px; font-weight: bold;">Nivå ${result.breakdown.kunskap}</td>
                                            </tr>
                                            <tr style="background: #f5f5f5;">
                                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>Erfarenhetskrav</strong></td>
                                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 18px; font-weight: bold;">Nivå ${result.breakdown.erfarenhet}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>Ledningsbehov</strong></td>
                                                <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-size: 18px; font-weight: bold;">Nivå ${result.breakdown.ledningsbehov}</td>
                                            </tr>
                                        </table>
                                        
                                        <h2 style="color: #2d3561;">📌 Nästa steg</h2>
                                        <p>Boka in ett möte för att diskutera självskattningen. Den gemensamma bedömningen blir underlag för utvecklingsplanen.</p>
                                        
                                        <p style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
                                            Fullständig rapport bifogas som PDF.<br>
                                            Detta meddelande skickades automatiskt från Kompetensbedömning IT-service.
                                        </p>
                                    </div>
                                </body>
                                </html>
                            `
                        },
                        toRecipients: toRecipients,
                        attachments: [
                            {
                                '@odata.type': '#microsoft.graph.fileAttachment',
                                name: `kompetensbedömning_${info.namn.replace(/\s+/g, '_')}_${datum.replace(/\s+/g, '_')}.pdf`,
                                contentType: 'application/pdf',
                                contentBytes: base64PDF
                            }
                        ]
                    },
                    saveToSentItems: true
                };

                // Skicka via Graph API med delegerade behörigheter (skickar från inloggad användare)
                const response = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailMessage)
                });

                if (response.ok || response.status === 202) {
                    let successMsg = `✅ E-post skickad!\n\n📨 Skickad från: ${currentUser.email}\n📬 Till: ${currentUser.email}`;
                    if (managerInfo?.email) {
                        successMsg += `\n👔 Till chef: ${managerInfo.email}`;
                    }
                    successMsg += '\n\n📎 PDF-rapport bifogad';
                    showEmailStatus(successMsg, false, true);
                } else {
                    const errorData = await response.json();
                    console.error('Mail API error:', errorData);
                    showEmailStatus(`❌ Kunde inte skicka e-post: ${errorData.error?.message || 'Okänt fel'}`, false, true);
                }

            } catch (error) {
                console.error('Email sending error:', error);
                showEmailStatus(`❌ Fel vid e-postutskick: ${error.message}`, false, true);
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // ═══════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════

        document.addEventListener('DOMContentLoaded', function() {
            fetchUserInfo();
            initializeMsal();
        });
    </script>
</body>
</html>
